# brainview Development information

This document is intended for developers who work on `brainview`. Users should ignore this file and install a release via `pip` instead. See the [README file in the repo root](../README.md) for details.

While `brainview` works on several platforms, development happens under Ubuntu Linux 18.04. I also work on brainview under MacOS High Sierra sometimes, but there I use Anaconda (and I do not describe the setup in this file).

## Essential tools

You will need Python and some standard development tools. You will also need a working matplotlib including a proper backend. I went for qt. Under a Debian-based Linux distro, this should be enough:

```console
sudo apt-get install python-pip build-essential git python-pyqt5 python-pyqt5.qtsvg
```

You will also need Python bindings for qt. You should install them in the virtual environment using `pip`, see below.


## Development installation

It is recommended to use a virtual environment for hacking on `brainview`. First, clone the repo:

```console
mkdir ~/develop/          # replace this dir with whatever you like or use an existing directory where you store all your code or projects.
cd ~/develop
git clone https://github.com/dfsp-spirit/brainview
cd brainview/             # we will refer to this directory as the `repository root` or `repo root` throughout this document.
```

Now let's prepare the dev environment. In the repo root:

```console
pip install --user virtualenv      # unless you already have it
python -m virtualenv env/          # creates a virtual python environment in the new directory `env/` in the repo root, i.e., `~/develop/brainview/env/` in our example
```


Note: Once you have created the virtual environment, all you have to do is use it. The first thing we'll do is install the Python bindings for qt I mentioned earlier:
```console
cd ~/develop/brainview             # replace with your repo root
source env/bin/activate            # to activate the virtual environment

pip install pyside2                # install bindings
some_other_command...              

deactivate                         # to leave it
```

Ensure that you are still in the repo root, then activate the virtual environment and install `brainview` in development mode:

```console
source env/bin/activate
pip install --editable .           # installs brainview from the current directory, and grabs its dependencies from PyPI
```

You can now use the `brainview` module by typing `import brainload` in your python application or an interactive python session. Changes you make to the module source are applied automatically.



## Tests

Tests and test data are not shipped in the releases. Follow the installation instructions for the development version if you want to run them. Once you have done that, continue from here.

### Running the tests locally

#### Obtaining the test data

Not all data is included with the repo, as the test data is quite large and some fake subjects are generated by copying others. The good news is that you can get all test data by running a single shell script from the repo root:

```console
cd ~/develop/brainview               # replace with your repo root
./develop/get_test_data_all.bash
```

The script downloads all required [neuroimaging test data from Github](https://github.com/dfsp-spirit/neuroimaging_testdata). If you have a properly configured local installation of FreeSurfer (with environment variable `FREESURFER_HOME` pointing to the installation directory), it will prefer that for some data.

#### Running the tests

There are several ways to run the tests. The easiest it to use the integration into `setup.py`, as this will install all test dependencies for you automatically. In the virtual environment and the top-level brainview directory, just run:

```console
python setup.py test
```

If you want to run the tests manually, you need `pytest` and `pytest-cov`, both of which can be installed via `pip`. Then just run:

```console
pytest
```

To run the tests with code coverage:

```console
pytest --cov=src/
```

### Continuous Integration

The tests are run automatically when you push to master and devs get results by email. Build status from travis-ci.org (Linux, branch master):

[![Build Status](https://travis-ci.org/dfsp-spirit/brainview.svg?branch=master)](https://travis-ci.org/dfsp-spirit/brainview)



## Packaging

### Creating the release package

Set the new version in `setup.py` and `src/brainview/__init__.py`:

```console
cd ~/develop/brainview/                       # repo root
git checkout master
git pull

vim setup.py                                # update version
vim src/brainview/__init__.py               # update version

git add setup.py src/brainview/__init__.py
git commit -m "Update version to 0.0.2."
```

Then make the release:

```console
pip install --upgrade setuptools wheel              # just make sure we have the latest versions
rm -rf dist
python setup.py sdist bdist_wheel --universal
twine upload dist/*

git tag -a v0.0.2 -m "Some annotation for this release."
git push origin --tags
```

TODO: Add the generation and distribution of the documentation to this workflow.


### Building the `brainview` documentation

We use sphinx with the theme from `readthedocs.org` to generate the documentation. In the virtual environment:

```console
pip install sphinx sphinx_rtd_theme
cd doc/
make html
```

This will build the documentation in HTML format and place it in `_build/html/` (relative to the `doc/` directory).

We will put the documentation online later (maybe on a GitHub page), but that does not make any sense yet.

Note that if you added new modules in separate directories, for the documentation to show up,
you will have to tell autodoc about the paths to the new directories by adding them to `sys.path`
at the top of the `doc/conf.py` file.


### Distributing the package


We are following the [official Python packaging user guide](https://packaging.python.org/tutorials/packaging-projects/) here. First make sure you have the required tools:

```console
pip install --upgrade twine            # in the virtual env. Add `--user` if you prefer to do it outside.
```

#### PyPI testing

```console
twine upload --repository-url https://test.pypi.org/legacy/ dist/*     # will ask for your PyPI test credentials for brainview
```

Now try it in a fresh virtual environment (you may have to wait a sec for it to become available):

```console
deactivate                                  # leave current virtual env
python -m virtualenv env_for_v2             # create a fresh one
source env_for_v2/bin/activate              # activate it
pip install --index-url https://test.pypi.org/simple/ brainview     # install it. now try the example client.
```

If it looks good, upload it to the real one:

#### PyPI

```console
twine upload dist/*                           # will ask for your PyPI credentials for brainview
```

#### Anaconda (build and distribution)

Not yet. This is WIP, see https://conda.io/docs/user-guide/tutorials/build-pkgs.html for instructions.

Some work has already been done, see the files in `development/anaconda_dist`.

Get the tools: install `conda` on your system and fire it up, then use it to get the build tools:

```console
conda install conda-build anaconda-client
```

Now, update the `meta.yaml` file with the build information, e.g., the files to include. This is the main step.

When that is done, build and upload the package:

```console
conda build .                    # will output `full/path/to/package.tar.bz2`, e.g., `.../conda-bld/osx-64/brainview-0.1.1-py27_0.tar.bz2`
anaconda login                   # will ask for your credentials
anaconda upload full/path/to/package.tar.bz2
```
